<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一篇就够了：React全家桶 | 潜心摸鱼，戒骄戒躁</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="....">
    <link rel="preload" href="/assets/css/0.styles.8ada974c.css" as="style"><link rel="preload" href="/assets/js/app.be40bd60.js" as="script"><link rel="preload" href="/assets/js/2.fcfb7384.js" as="script"><link rel="preload" href="/assets/js/11.416a0fa6.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ac570e.js"><link rel="prefetch" href="/assets/js/12.0b6b2e75.js"><link rel="prefetch" href="/assets/js/3.c76c3f2c.js"><link rel="prefetch" href="/assets/js/4.b6579f35.js"><link rel="prefetch" href="/assets/js/5.b086611e.js"><link rel="prefetch" href="/assets/js/6.9ea11631.js"><link rel="prefetch" href="/assets/js/7.296733e2.js"><link rel="prefetch" href="/assets/js/8.d1df2860.js"><link rel="prefetch" href="/assets/js/9.89661334.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ada974c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">潜心摸鱼，戒骄戒躁</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端知识体系" class="dropdown-title"><span class="title">前端知识体系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/react.html" class="nav-link router-link-exact-active router-link-active">
  一篇就够了：React全家桶
</a></li><li class="dropdown-item"><!----> <a href="/articles/network.html" class="nav-link">
  一篇就够了：Http基础知识一网打尽
</a></li><li class="dropdown-item"><!----> <a href="/articles/optimize.html" class="nav-link">
  一篇就够了：前端性能优化
</a></li><li class="dropdown-item"><!----> <a href="/articles/css.html" class="nav-link">
  必知必会：CSS
</a></li><li class="dropdown-item"><!----> <a href="/articles/es6.html" class="nav-link">
  必知必会：JavaScript与ES6
</a></li><li class="dropdown-item"><!----> <a href="/articles/node.html" class="nav-link">
  必知必会：Node.js
</a></li><li class="dropdown-item"><!----> <a href="/articles/design-patterns.html" class="nav-link">
  必知必会：设计模式
</a></li><li class="dropdown-item"><!----> <a href="/articles/security.html" class="nav-link">
  必知必会：Web安全
</a></li><li class="dropdown-item"><!----> <a href="/articles/algorithm.html" class="nav-link">
  必知必会：算法
</a></li><li class="dropdown-item"><!----> <a href="/articles/engineer.html" class="nav-link">
  必知必会：工程化与部署
</a></li><li class="dropdown-item"><!----> <a href="/articles/multi-terminal.html" class="nav-link">
  快速上手：多端（Taro）
</a></li><li class="dropdown-item"><!----> <a href="/articles/webpack-v5.html" class="nav-link">
  快速上手：Webpack 5.0
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="手写题" class="dropdown-title"><span class="title">手写题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/debounce-throttle.html" class="nav-link">
  防抖、节流
</a></li><li class="dropdown-item"><!----> <a href="/articles/copy.html" class="nav-link">
  深浅拷贝
</a></li><li class="dropdown-item"><!----> <a href="/articles/entrust.html" class="nav-link">
  事件委托
</a></li><li class="dropdown-item"><!----> <a href="/articles/new.html" class="nav-link">
  new
</a></li><li class="dropdown-item"><!----> <a href="/articles/promise.html" class="nav-link">
  promise
</a></li><li class="dropdown-item"><!----> <a href="/articles/call-apply-bind.html" class="nav-link">
  call、apply、bind
</a></li><li class="dropdown-item"><!----> <a href="/articles/curry.html" class="nav-link">
  函数柯里化
</a></li><li class="dropdown-item"><!----> <a href="/articles/drag-dom.html" class="nav-link">
  实现拖拽div
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="有趣的小项目" class="dropdown-title"><span class="title">有趣的小项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/little-news.html" class="nav-link">
  Chrome插件：前端小报
</a></li><li class="dropdown-item"><!----> <a href="/articles/green-wall.html" class="nav-link">
  VSCode插件：用Github小绿点画个画
</a></li><li class="dropdown-item"><!----> <a href="/articles/ftp-deploy.html" class="nav-link">
  Webpack Plugin：ftpDeploy
</a></li><li class="dropdown-item"><!----> <a href="/articles/multi-language.html" class="nav-link">
  Webpack Loader：多语言
</a></li><li class="dropdown-item"><!----> <a href="/articles/apm.html" class="nav-link">
  前端性能监控系统搭建
</a></li><li class="dropdown-item"><!----> <a href="/articles/code-rule.html" class="nav-link">
  团队开发：代码规范
</a></li><li class="dropdown-item"><!----> <a href="/articles/cli.html" class="nav-link">
  团队开发：React项目脚手架
</a></li><li class="dropdown-item"><!----> <a href="/articles/component.html" class="nav-link">
  团队开发：React项目组件库
</a></li><li class="dropdown-item"><!----> <a href="/articles/component.html" class="nav-link">
  团队开发：项目模板
</a></li></ul></div></div> <a href="https://github.com/Xumengxiang/inner-peace" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端知识体系" class="dropdown-title"><span class="title">前端知识体系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/react.html" class="nav-link router-link-exact-active router-link-active">
  一篇就够了：React全家桶
</a></li><li class="dropdown-item"><!----> <a href="/articles/network.html" class="nav-link">
  一篇就够了：Http基础知识一网打尽
</a></li><li class="dropdown-item"><!----> <a href="/articles/optimize.html" class="nav-link">
  一篇就够了：前端性能优化
</a></li><li class="dropdown-item"><!----> <a href="/articles/css.html" class="nav-link">
  必知必会：CSS
</a></li><li class="dropdown-item"><!----> <a href="/articles/es6.html" class="nav-link">
  必知必会：JavaScript与ES6
</a></li><li class="dropdown-item"><!----> <a href="/articles/node.html" class="nav-link">
  必知必会：Node.js
</a></li><li class="dropdown-item"><!----> <a href="/articles/design-patterns.html" class="nav-link">
  必知必会：设计模式
</a></li><li class="dropdown-item"><!----> <a href="/articles/security.html" class="nav-link">
  必知必会：Web安全
</a></li><li class="dropdown-item"><!----> <a href="/articles/algorithm.html" class="nav-link">
  必知必会：算法
</a></li><li class="dropdown-item"><!----> <a href="/articles/engineer.html" class="nav-link">
  必知必会：工程化与部署
</a></li><li class="dropdown-item"><!----> <a href="/articles/multi-terminal.html" class="nav-link">
  快速上手：多端（Taro）
</a></li><li class="dropdown-item"><!----> <a href="/articles/webpack-v5.html" class="nav-link">
  快速上手：Webpack 5.0
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="手写题" class="dropdown-title"><span class="title">手写题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/debounce-throttle.html" class="nav-link">
  防抖、节流
</a></li><li class="dropdown-item"><!----> <a href="/articles/copy.html" class="nav-link">
  深浅拷贝
</a></li><li class="dropdown-item"><!----> <a href="/articles/entrust.html" class="nav-link">
  事件委托
</a></li><li class="dropdown-item"><!----> <a href="/articles/new.html" class="nav-link">
  new
</a></li><li class="dropdown-item"><!----> <a href="/articles/promise.html" class="nav-link">
  promise
</a></li><li class="dropdown-item"><!----> <a href="/articles/call-apply-bind.html" class="nav-link">
  call、apply、bind
</a></li><li class="dropdown-item"><!----> <a href="/articles/curry.html" class="nav-link">
  函数柯里化
</a></li><li class="dropdown-item"><!----> <a href="/articles/drag-dom.html" class="nav-link">
  实现拖拽div
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="有趣的小项目" class="dropdown-title"><span class="title">有趣的小项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/little-news.html" class="nav-link">
  Chrome插件：前端小报
</a></li><li class="dropdown-item"><!----> <a href="/articles/green-wall.html" class="nav-link">
  VSCode插件：用Github小绿点画个画
</a></li><li class="dropdown-item"><!----> <a href="/articles/ftp-deploy.html" class="nav-link">
  Webpack Plugin：ftpDeploy
</a></li><li class="dropdown-item"><!----> <a href="/articles/multi-language.html" class="nav-link">
  Webpack Loader：多语言
</a></li><li class="dropdown-item"><!----> <a href="/articles/apm.html" class="nav-link">
  前端性能监控系统搭建
</a></li><li class="dropdown-item"><!----> <a href="/articles/code-rule.html" class="nav-link">
  团队开发：代码规范
</a></li><li class="dropdown-item"><!----> <a href="/articles/cli.html" class="nav-link">
  团队开发：React项目脚手架
</a></li><li class="dropdown-item"><!----> <a href="/articles/component.html" class="nav-link">
  团队开发：React项目组件库
</a></li><li class="dropdown-item"><!----> <a href="/articles/component.html" class="nav-link">
  团队开发：项目模板
</a></li></ul></div></div> <a href="https://github.com/Xumengxiang/inner-peace" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/react.html" class="active sidebar-link">一篇就够了：React全家桶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/react.html#react" class="sidebar-link">React</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/react.html#virtual-dom" class="sidebar-link">Virtual Dom</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#react最新的生命周期" class="sidebar-link">React最新的生命周期</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#setstate是同步操作还是异步操作" class="sidebar-link">setState是同步操作还是异步操作</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#react如何实现组件间通信" class="sidebar-link">React如何实现组件间通信</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#组件-逻辑复用方式比较" class="sidebar-link">组件/逻辑复用方式比较</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#react-fiber架构解析" class="sidebar-link">React Fiber架构解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/react.html#redux" class="sidebar-link">Redux</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/react.html#redux的工作流程" class="sidebar-link">Redux的工作流程</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#react-redux" class="sidebar-link">React-Redux</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#react-redux中如何进行异步操作" class="sidebar-link">React-Redux中如何进行异步操作</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#redux中间件比较" class="sidebar-link">Redux中间件比较</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/react.html#react-router" class="sidebar-link">React-Router</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/react.html#hash路由" class="sidebar-link">Hash路由</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#history路由" class="sidebar-link">History路由</a></li><li class="sidebar-sub-header"><a href="/articles/react.html#路由切换动画" class="sidebar-link">路由切换动画</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一篇就够了：react全家桶"><a href="#一篇就够了：react全家桶" class="header-anchor">#</a> 一篇就够了：<code>React</code>全家桶</h1> <p><img src="/react.jpg" alt="一篇就够了：React 全家桶"></p> <h2 id="react"><a href="#react" class="header-anchor">#</a> <code>React</code></h2> <h3 id="virtual-dom"><a href="#virtual-dom" class="header-anchor">#</a> <code>Virtual Dom</code></h3> <h4 id="什么是virtual-dom"><a href="#什么是virtual-dom" class="header-anchor">#</a> 什么是<code>Virtual Dom</code></h4> <p><code>Virtual Dom</code>是对<code>Dom</code>的抽象，本质上是一个<code>JavaScript</code>对象，这个对象是对<code>Dom</code>的轻量级描述。</p> <h4 id="为什么需要virtual-dom"><a href="#为什么需要virtual-dom" class="header-anchor">#</a> 为什么需要<code>Virtual Dom</code></h4> <p>既然我们已经有了<code>Dom</code>，为什么还需要<code>Virtual Dom</code>呢？主要原因有以下三点：</p> <ul><li><strong>性能需要</strong>：<code>Dom</code>操作相对较慢，并且频繁操作<code>Dom</code>容易造成浏览器的回流和重绘，严重影响性能。<code>Virtual Dom</code>可以尽可能的减少<code>Dom</code>操作的次数。</li> <li><strong>现代前端框架的基本要求</strong>：现代前端框架的一个基本要求就是无需手动操作<code>Dom</code>，原因有二：一、无法保证性能；二、省略<code>Dom</code>操作可以大大提高开发效率。</li> <li><strong>跨平台</strong>：<code>Virtual Dom</code>的最初目的就是解决跨平台的问题，比如<code>Node.js</code>本身没有<code>Dom</code>，如果想要实现<code>SSR</code>，一种可行的方式就是借助<code>Virtual Dom</code>，因为<code>Virtual Dom</code>本身只是一个<code>JavaScript</code>对象。</li></ul> <h4 id="关键知识点（以snabbdom-js为例）"><a href="#关键知识点（以snabbdom-js为例）" class="header-anchor">#</a> 关键知识点（以<code>snabbdom.js</code>为例）</h4> <h5 id="根据dom节点创建vnode"><a href="#根据dom节点创建vnode" class="header-anchor">#</a> 根据<code>Dom</code>节点创建<code>VNode</code></h5> <p><code>VNode</code>是<code>Dom</code>节点的抽象，那么我们很容易定义它的形式。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> String， <span class="token comment">// String，DOM 节点的类型，如 'div'/'span'</span>
  data<span class="token operator">:</span> Object<span class="token punctuation">,</span>  <span class="token comment">// Object，包括 props，style等等 DOM 节点的各种属性</span>
  children<span class="token operator">:</span> Array <span class="token comment">// Array，子节点（子 vnode）</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们来看一下<code>snabbdom.js</code>中是怎么定义<code>VNode</code>的：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
  sel<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// VNode的选择器，nodeName+id+class的组合</span>
  data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 存放VNodeData的地方，具体见下面的VNodeData定义</span>
  children<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode <span class="token operator">|</span> <span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// vnode的子vnode的地方</span>
  elm<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 存储vnode对应的真实的dom的地方</span>
  text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// vnode的text文本，和children只能二选一</span>
  key<span class="token operator">:</span> Key <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// vnode的key值，主要用于后续vnode的diff过程</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNodeData</span> <span class="token punctuation">{</span>
  props<span class="token operator">?</span><span class="token operator">:</span> Props<span class="token punctuation">;</span> <span class="token comment">// vnode上传递的其他属性</span>
  attrs<span class="token operator">?</span><span class="token operator">:</span> Attrs<span class="token punctuation">;</span> <span class="token comment">// vnode上的其他dom属性，可以通过setAttribute来设置或删除的。</span>
  <span class="token keyword">class</span><span class="token operator">?</span><span class="token operator">:</span> Classes<span class="token punctuation">;</span> <span class="token comment">// vnode上的class的属性集合</span>
  style<span class="token operator">?</span><span class="token operator">:</span> VNodeStyle<span class="token punctuation">;</span> <span class="token comment">// vnode上的style属性集合</span>
  dataset<span class="token operator">?</span><span class="token operator">:</span> Dataset<span class="token punctuation">;</span> <span class="token comment">// vnode挂载的数据集合</span>
  on<span class="token operator">?</span><span class="token operator">:</span> On<span class="token punctuation">;</span>  <span class="token comment">// 监听的事件集合</span>
  hero<span class="token operator">?</span><span class="token operator">:</span> Hero<span class="token punctuation">;</span>
  attachData<span class="token operator">?</span><span class="token operator">:</span> AttachData<span class="token punctuation">;</span> <span class="token comment">// 额外附加的数据</span>
  hook<span class="token operator">?</span><span class="token operator">:</span> Hooks<span class="token punctuation">;</span> <span class="token comment">// vnode的钩子函数集合，主要用于在不同阶段调用不通过的钩子函数</span>
  key<span class="token operator">?</span><span class="token operator">:</span> Key<span class="token punctuation">;</span>
  ns<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// for SVGs 命名空间，主要用于SVG</span>
  fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> VNode<span class="token punctuation">;</span> <span class="token comment">// for thunks</span>
  args<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">// for thunks</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> <span class="token comment">// for any other 3rd party module</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>snabbdom.js</code>中不仅仅存在<code>VNode</code>和<code>VNodeData</code>两个数据模型，还有一个生成<code>VNode</code>的工具方法<code>vnode</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 参数是sel，data，children，text，elm，返回值是一个VNode的对象</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      data<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      children<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode <span class="token operator">|</span> <span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      elm<span class="token operator">:</span> Element <span class="token operator">|</span> Text <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">let</span> key <span class="token operator">=</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>sel<span class="token operator">:</span> sel<span class="token punctuation">,</span> data<span class="token operator">:</span> data<span class="token punctuation">,</span> children<span class="token operator">:</span> children<span class="token punctuation">,</span> text<span class="token operator">:</span> text<span class="token punctuation">,</span> elm<span class="token operator">:</span> elm<span class="token punctuation">,</span> key<span class="token operator">:</span> key<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有了<code>VNode</code>和生成<code>VNode</code>的函数，接下来我们看看如何将真实的<code>Dom</code>节点转化为<code>VNode</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 参数是要求一个真实的dom对象</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toVNode</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> Node<span class="token punctuation">,</span> domApi<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">DOMAPI</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token comment">// 这边定义了一个变量叫api，主要是一些用于dom操作的api接口。</span>
  <span class="token keyword">const</span> api<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi<span class="token punctuation">;</span>
  <span class="token comment">// 定义了text的变量</span>
  <span class="token keyword">let</span> text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果node是一个element类型的dom对象就进行如下的操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">isElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获得node的id，变成#id </span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> node<span class="token punctuation">.</span>id <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
   <span class="token comment">// 获得class，变成.class1.class2这样的形式</span>
    <span class="token keyword">const</span> cn <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> cn <span class="token operator">?</span> <span class="token string">'.'</span> <span class="token operator">+</span> cn<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
   <span class="token comment">// sel 变成tagName+id+class的形式，比如&lt;div id=id class=class&gt;&lt;/div&gt;的sel的值就变成了div#id.class</span>
    <span class="token keyword">const</span> sel <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">tagName</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> id <span class="token operator">+</span> c<span class="token punctuation">;</span>
   <span class="token comment">// 定义一系列后续需要使用的attrs，children等对象。</span>
    <span class="token keyword">const</span> attrs<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> children<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> n<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    <span class="token comment">// 获得元素里所有的attrs</span>
    <span class="token keyword">const</span> elmAttrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>
   <span class="token comment">// 获得元素中所有子节点,这边不用children</span>
    <span class="token keyword">const</span> elmChildren <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> elmAttrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> elmAttrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nodeName<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'id'</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">!==</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 把非id和class的属性值放到attrs中</span>
        attrs<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> elmAttrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nodeValue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> elmChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过递归的方式把子节点翻译成vnode放入children数组中</span>
      children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">toVNode</span><span class="token punctuation">(</span>elmChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> domApi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment">// 生成完整的vnode并返回</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> <span class="token punctuation">{</span>attrs<span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">isText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果node是一个textContent类型的就返回文本的vnode</span>
    text <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getTextContent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">isComment</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果node是一个comment类型的就返回sel是&quot;!&quot;的文本的vnode</span>
    text <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getTextContent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> node <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果什么都不是就返回一个空的vnode</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> node <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="根据vnode生成真实的dom节点"><a href="#根据vnode生成真实的dom节点" class="header-anchor">#</a> 根据<code>VNode</code>生成真实的<code>Dom</code>节点</h5> <p>我们已经有了各种方法来生成一个<code>VNode</code>，包括从普通<code>js</code>对象生成，从真实的<code>Dom</code>来生成。但是我们怎么从<code>VNode</code>生成真实的<code>Dom</code>呢？接下来让我们来看看<code>snabbdom.js</code>中最重要的主代码<code>snabbdom.ts</code>。</p> <p>利用<code>VNode</code>生成真实<code>Dom</code>在<code>snabbdom</code>中主要是通过<code>createElm</code>方法来实现，该方法放在<code>snabbdom.ts</code>中。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>  <span class="token comment">//根据VNode创建element</span>
  <span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果VNodeData存在且hooks里有init函数,则执行init函数,然后重新赋值VNodeData</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 子虚拟dom,</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> sel <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>
    <span class="token comment">// 当sel == &quot;!&quot;的时候表示这个vnode就是一个comment</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Parse selector 这么一段就是为了从sel中获得tag值,id值,class值</span>
      <span class="token keyword">const</span> hashIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dotIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> hashIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> hash <span class="token operator">=</span> hashIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> hashIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> dot <span class="token operator">=</span> dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> dotIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> tag <span class="token operator">=</span> hashIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> dotIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> sel<span class="token punctuation">;</span>
      <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">?</span> api<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
                                                                               <span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置元素的id</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;</span> dot<span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置元素的class</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\./g</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用create钩子</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ch <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//深度遍历</span>
            api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      i <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token keyword">as</span> VNodeData<span class="token punctuation">)</span><span class="token punctuation">.</span>hook<span class="token punctuation">;</span> <span class="token comment">// Reuse variable</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>create<span class="token punctuation">)</span> i<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当insert的hook存在,就在插入Vnode的队列中加入该vnode</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>insert<span class="token punctuation">)</span> insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 其他的情况就当vnode是一个简单的TextNode</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="diff算法"><a href="#diff算法" class="header-anchor">#</a> <code>diff</code>算法</h5> <p>我们已经把<code>complie</code>的阶段弄的差不多了，现在只剩下，怎么比较<code>oldVnode</code>与<code>newVnode</code>两个<code>vnode</code>，并实现<code>DOM</code>树更新？也就是我们前面提到的<code>diff</code>方法和<code>patch</code>过程，在<code>snabbdom.ts</code>，<code>diff</code>和<code>patch</code>都写在一起，我们继续往下看。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>  <span class="token comment">// 只要这两个虚拟元素的sel(选择器)和key一样就是same的</span>
  <span class="token keyword">function</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span><span class="token parameter">vnode1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode2<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> vnode1<span class="token punctuation">.</span>key <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> vnode1<span class="token punctuation">.</span>sel <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// patch过程</span>
  <span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> hook<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用全局hook里定义的事件的地方。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>hook <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> hook<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 因为 vnode 和 oldVnode 是相同的 vnode，所以我们可以复用 oldVnode.elm。</span>
    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token keyword">let</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果 vnode.text 是 undefined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 核心逻辑（最复杂的地方）：怎么比较新旧 children 并更新，对应上面</span>
        <span class="token comment">// 的数组比较</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span> ch <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加新 children</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首先删除原来的 text</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 然后添加新 dom（对 ch 中每个 vnode 递归创建 dom 并插入到 elm）</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ch <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 相反地，如果原来有 children 而现在没有，那么我们要删除 children。</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>oldCh <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 最后，如果 oldVnode 有 text，删除。</span>
        api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 否则 （vnode 有 text），只要 text 不等，更新 dom 的 text。</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> hook<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// diff算法的重点</span>
  <span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
                          oldCh<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
                          newCh<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
                          insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// parentElm:Node</span>
    <span class="token comment">// oldCh: Array&lt;VNode&gt;</span>
    <span class="token comment">// newCh: Array&lt;VNode&gt;</span>
    <span class="token comment">// insertdVnodeQuenen: VNodeQuenen</span>
    <span class="token comment">// 和patchVnode形成了精巧递归</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldKeyToIdx<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> idxInOld<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> elmToMove<span class="token operator">:</span> VNode<span class="token punctuation">;</span>
    <span class="token keyword">let</span> before<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

    <span class="token comment">// 当oldCh和newCh其中还有一个没有比较完的话，就执行下的函数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Vnode might have been moved left</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
        <span class="token comment">// 把获得更新后的 (oldStartVnode/newEndVnode) 的 dom 右移，移动到</span>
        <span class="token comment">// oldEndVnode 对应的 dom 的右边。为什么这么右移？</span>
        <span class="token comment">// （1）oldStartVnode 和 newEndVnode 相同，显然是 vnode 右移了。</span>
        <span class="token comment">// （2）若 while 循环刚开始，那移到 oldEndVnode.elm 右边就是最右边，是合理的；</span>
        <span class="token comment">// （3）若循环不是刚开始，因为比较过程是两头向中间，那么两头的 dom 的位置已经是</span>
        <span class="token comment">//     合理的了，移动到 oldEndVnode.elm 右边是正确的位置；</span>
        <span class="token comment">// （4）记住，oldVnode 和 vnode 是相同的才 patch，且 oldVnode 自己对应的 dom</span>
        <span class="token comment">//     总是已经存在的，vnode 的 dom 是不存在的，直接复用 oldVnode 对应的 dom。</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
        <span class="token comment">//更新新旧vnode的值，然后vnode左移</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldKeyToIdx <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 新的children中的startVnode元素没有在旧children中找到</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
          api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 新的children中的startNode元素在旧children中找到元素</span>
          elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// 如果sel不相等则必须重新创建一个新的ele</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>sel <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新操作</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm <span class="token keyword">as</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="react最新的生命周期"><a href="#react最新的生命周期" class="header-anchor">#</a> <code>React</code>最新的生命周期</h3> <p><code>React</code> 从 <code>v16.3</code> 开始，对生命周期进行了渐进式的调整。废弃了一些生命周期方法和添加了一些新的生命周期方法。</p> <h4 id="原·生命周期方法"><a href="#原·生命周期方法" class="header-anchor">#</a> 原·生命周期方法</h4> <p><img src="/old-funcs.jpg" alt="原·生命周期"></p> <h4 id="新·生命周期方法"><a href="#新·生命周期方法" class="header-anchor">#</a> 新·生命周期方法</h4> <p><img src="/new-funcs.jpg" alt="新·生命周期"></p> <h5 id="废弃的生命周期方法"><a href="#废弃的生命周期方法" class="header-anchor">#</a> 废弃的生命周期方法</h5> <ul><li><code>componentWillMount</code></li> <li><code>componentWillReceiveProps</code></li> <li><code>componentWillUpdate</code></li></ul> <h5 id="新增的生命周期方法"><a href="#新增的生命周期方法" class="header-anchor">#</a> 新增的生命周期方法</h5> <ul><li><code>getDerivedStateFromProps</code></li> <li><code>getSnapshotBeforeUpdate</code></li></ul> <h5 id="挂载"><a href="#挂载" class="header-anchor">#</a> 挂载</h5> <p><strong><code>constructor()</code></strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
</code></pre></div><p><code>React</code> 组件在挂载前，会调用它的构造函数，在构造函数内部必须执行一次<code>super(props)</code>。不能再<code>constructor</code>内部调用<code>this.setState</code>。 通常用于：</p> <ul><li>通过给this.state初始化内部状态</li> <li>为事件处理函数绑定this</li></ul> <p><strong><code>static getDerivedStateFromProps()</code></strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span>prevState<span class="token punctuation">)</span>
</code></pre></div><p>是一个静态方法，父组件传入的<code>newProps</code>和当前组件的<code>prevState</code>进行比较，判断时候需要更新<code>state</code>，返回值对象用作更新<code>state</code>，如果不需要则返回<code>null</code>。在<code>render()</code>方法之前调用，并且在初始挂载和后续更新时调用。</p> <p><strong><code>render()</code></strong></p> <p><code>render()</code>是组件中唯一必须实现的方法。<code>render()</code> 函数应该是纯函数。不能够调用<code>setState</code>。</p> <p><strong><code>componentDidMount()</code></strong></p> <p>组件加载完成，能够获取真是的 <code>DOM</code> 在此阶段可以<code>ajax</code>请求和绑定事件，在此阶段绑定了时间要在<code>componentWillUnmount()</code>取消。在此阶段可以调用<code>setState</code>，触发<code>render</code>渲染，但会影响性能。</p> <h5 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h5> <p><strong><code>static getDerivedStateFromProps()</code></strong></p> <p>和挂载阶段一致。</p> <p><strong><code>shouldComponentUpate()</code></strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span>state<span class="token punctuation">)</span>
</code></pre></div><p>在已挂载的组件，当<code>props</code>或者<code>state</code>发生变化时，会在渲染前调用。根据父组件的 <code>props</code> 和当前的 <code>state</code> 进行对比，返回<code>true</code>/<code>false</code>。决定是否触发后续的生命周期函数。</p> <p><strong><code>render()</code></strong></p> <p>和挂载阶段一致。</p> <p><strong><code>getSnapshotBeforeUpdate()</code></strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span>prevState<span class="token punctuation">)</span>
</code></pre></div><p>在真实的 <code>DOM</code> 更新前调用。可获取一些有用的信息然后作为参数传递给<code>componentDidUpdate()</code>。<code>prevProps</code>表示更新前的<code>props</code>,<code>prevState</code>表示更新前的<code>state</code>。</p> <p>在<code>render()</code>之后<code>componentDidUpdate()</code>之前调用。此方法的返回值<code>(snaphot)</code>可作为<code>componentDidUpdate()</code>的第三个参数使用。如不需要返回值则直接返回<code>null</code>。</p> <p><strong><code>componentDidUpdate</code></strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span>
</code></pre></div><p>该方法会在更新完成后立即调用。首次渲染不会执行此方法。当组件更新后，可以在此处对 <code>DOM</code> 进行操作。可以在此阶段使用<code>setState</code>，触发<code>render()</code>但必须包裹在一个条件语句里，以避免死循环。</p> <h5 id="卸载"><a href="#卸载" class="header-anchor">#</a> 卸载</h5> <p><strong><code>componentWillUnmount</code></strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>会在组件卸载和销毁之前直接调用。此方法主要用来执行一些清理工作，例如：定时器，清除事件绑定，取消网络请求。</p> <h3 id="setstate是同步操作还是异步操作"><a href="#setstate是同步操作还是异步操作" class="header-anchor">#</a> <code>setState</code>是同步操作还是异步操作</h3> <ul><li><code>setState</code>只在合成事件和钩子函数中是“异步”的，在原生事件和<code>setTimeout</code>中都是同步的。</li> <li><code>setState</code>的“异步”并不是说内部由异步代码实现，其实本身执行的过程和代码都是同步的，只是合成事件和钩子函数的调用顺序在更新之前，导致在合成事件和钩子函数中没法立马拿到更新后的值，形成了所谓的“异步”，当然可以通过第二个参数 <code>setState(partialState, callback)</code> 中的<code>callback</code>拿到更新后的结果。</li> <li><code>setState</code>的批量更新优化也是建立在“异步”（合成事件、钩子函数）之上的，在原生事件和<code>setTimeout</code>中不会批量更新，在“异步”中如果对同一个值进行多次<code>setState</code>，<code>setState</code>的批量更新策略会对其进行覆盖，取最后一次的执行，如果是同时<code>setState</code>多个不同的值，在更新时会对其进行合并批量更新。</li></ul> <h3 id="react如何实现组件间通信"><a href="#react如何实现组件间通信" class="header-anchor">#</a> <code>React</code>如何实现组件间通信</h3> <ul><li>父组件向子组件通讯: 父组件可以向子组件通过传<code>props</code>的方式，向子组件进行通讯。</li> <li>子组件向父组件通讯: <code>props</code> + 回调的方式,父组件向子组件传递<code>props</code>进行通讯，此<code>props</code>为作用域为父组件自身的函数，子组件调用该函数，将子组件想要传递的信息，作为参数，传递到父组件的作用域中。</li> <li>兄弟组件通信: 找到这两个兄弟节点共同的父节点,结合上面两种方式由父节点转发信息进行通信。</li> <li>跨层级通信: <code>Context</code>设计目的是为了共享那些对于一个组件树而言是“全局”的数据，例如当前认证的用户、主题或首选语言,对于跨越多层的全局数据通过<code>Context</code>通信再适合不过。</li> <li>发布订阅模式: 发布者发布事件，订阅者监听事件并做出反应,我们可以通过引入<code>event</code>模块进行通信。</li> <li>全局状态管理工具: 借助<code>Redux</code>或者<code>Mobx</code>等全局状态管理工具进行通信,这种工具会维护一个全局状态中心<code>Store</code>,并根据不同的事件产生新的状态。</li></ul> <p><img src="/redux.png" alt="React如何实现组件间通信"></p> <h3 id="组件-逻辑复用方式比较"><a href="#组件-逻辑复用方式比较" class="header-anchor">#</a> 组件/逻辑复用方式比较</h3> <p>主要对组件复用的三种方式进行比较：<code>HOC</code>、<code>Render Props</code>、<code>Hooks</code>。</p> <h4 id="hoc-优势"><a href="#hoc-优势" class="header-anchor">#</a> <code>HOC</code> - 优势</h4> <ul><li><code>HOC</code>通过外层组件通过<code>Props</code>影响内层组件的状态，而不是直接改变其<code>State</code>不存在冲突和互相干扰，这就降低了耦合度</li> <li><code>HOC</code>具有天然的层级结构（组件树结构），这又降低了复杂度</li></ul> <h4 id="hoc-劣势"><a href="#hoc-劣势" class="header-anchor">#</a> <code>HOC</code> - 劣势</h4> <ul><li><strong>扩展性限制</strong>: <code>HOC</code>无法从外部访问子组件的<code>State</code>，因此无法通过<code>shouldComponentUpdate</code>滤掉不必要的更新，<code>React</code>在支持<code>ES6 Class</code>之后提供了<code>React.PureComponent</code>来解决这个问题。</li> <li><strong><code>Ref</code> 传递问题</strong>: <code>Ref</code> 被隔断，后来的<code>React.forwardRef</code> 来解决这个问题。</li> <li><strong><code>Wrapper Hell</code></strong>: <code>HOC</code>可能出现多层包裹组件的情况，多层抽象同样增加了复杂度和理解成本。</li> <li><strong>命名冲突</strong>: 如果高阶组件多次嵌套，没有使用命名空间的话会产生冲突，然后覆盖老属性。</li> <li><strong>不可见性</strong>: <code>HOC</code>相当于在原有组件外层再包装一个组件，你压根不知道外层的包装是啥，对于你是黑盒。</li></ul> <h4 id="render-props-优势"><a href="#render-props-优势" class="header-anchor">#</a> <code>Render Props</code> - 优势</h4> <ul><li>上述<code>HOC</code>的缺点<code>Render Props</code>都可以解决</li></ul> <h4 id="render-props-劣势"><a href="#render-props-劣势" class="header-anchor">#</a> <code>Render Props</code> - 劣势</h4> <ul><li><strong>使用繁琐</strong>: <code>HOC</code>使用只需要借助装饰器语法通常一行代码就可以进行复用，<code>Render Props</code>无法做到如此简单。</li> <li><strong>嵌套过深</strong>: <code>Render Props</code>虽然摆脱了组件多层嵌套的问题，但是转化为了函数回调的嵌套。</li></ul> <h4 id="hooks-优势"><a href="#hooks-优势" class="header-anchor">#</a> <code>Hooks</code> - 优势</h4> <ul><li><strong>简洁</strong>: <code>React Hooks</code>解决了<code>HOC</code>和<code>Render Props</code>的嵌套问题，更加简洁。</li> <li><strong>解耦</strong>: <code>React Hooks</code>可以更方便地把 <code>UI</code> 和状态分离，做到更彻底的解耦。</li> <li><strong>组合</strong>: <code>Hooks</code> 中可以引用另外的 <code>Hooks</code>形成新的<code>Hooks</code>，组合变化万千。</li> <li><strong>函数友好</strong>: <code>React Hooks</code>为函数组件而生，从而解决了类组件的几大问题:
<ul><li><code>this</code>指向容易错误</li> <li>分割在不同声明周期中的逻辑使得代码难以理解和维护</li> <li>代码复用成本高（高阶组件容易使代码量剧增）</li></ul></li></ul> <h4 id="hooks-劣势"><a href="#hooks-劣势" class="header-anchor">#</a> <code>Hooks</code> - 劣势</h4> <ul><li>额外的学习成本（<code>Functional Component</code> 与 <code>Class Component</code> 之间的困惑）</li> <li>写法上有限制（不能出现在条件、循环中），并且写法限制增加了重构成本</li> <li>破坏了<code>PureComponent</code>、<code>React.memo</code>浅比较的性能优化效果（为了取最新的<code>props</code>和<code>state</code>，每次<code>render()</code>都要重新创建事件处理函数）</li> <li>在闭包场景可能会引用到旧的<code>state</code>、<code>props</code>值</li> <li>内部实现上不直观（依赖一份可变的全局状态，不再那么“纯”）</li> <li><code>React.memo</code>并不能完全替代<code>shouldComponentUpdate</code>（因为拿不到 <code>state change</code>，只针对 <code>props change</code>）</li></ul> <h3 id="react-fiber架构解析"><a href="#react-fiber架构解析" class="header-anchor">#</a> <code>React Fiber</code>架构解析</h3> <h4 id="react-v15存在的问题"><a href="#react-v15存在的问题" class="header-anchor">#</a> <code>React v15</code>存在的问题</h4> <p><code>React</code>在进行组件渲染时，从<code>setState</code>开始到渲染完成整个过程是同步的（“一气呵成”）。如果需要渲染的组件比较庞大，<code>js</code>执行会占据主线程时间较长，会导致页面响应度变差，使得<code>React</code>在动画、手势等应用中效果比较差。</p> <h5 id="卡顿原因"><a href="#卡顿原因" class="header-anchor">#</a> 卡顿原因</h5> <p><code>Stack reconciler</code>的工作流程很像函数的调用过程。父组件里调子组件，可以类比为函数的递归（这也是为什么被称为<code>stack reconciler</code>的原因）。在<code>setState</code>后，<code>React</code>会立即开始<code>reconciliation</code>过程，从父节点（<code>Virtual DOM</code>）开始遍历，以找出不同。将所有的<code>Virtual DOM</code>遍历完成后，<code>reconciler</code>才能给出当前需要修改真实<code>DOM</code>的信息，并传递给<code>renderer</code>，进行渲染，然后屏幕上才会显示此次更新内容。对于特别庞大的<code>vDOM</code>树来说，<code>reconciliation</code>过程会很长(<code>x00ms</code>)，在这期间，主线程是被<code>js</code>占用的，因此任何交互、布局、渲染都会停止，给用户的感觉就是页面被卡住了。</p> <h4 id="react-v16的解决思路"><a href="#react-v16的解决思路" class="header-anchor">#</a> <code>React v16</code>的解决思路</h4> <p>为了解决这个问题，<code>React</code>团队经过两年的工作，重写了<code>React</code>中核心算法——<code>reconciliation</code>。并在<code>v16</code>版本中发布了这个新的特性。为了区别之前和之后的<code>reconciler</code>，通常将之前的<code>reconciler</code>称为<code>stack reconciler</code>，重写后的称为<code>fiber reconciler</code>，简称为<code>Fiber</code>。</p> <h4 id="fiber的原理"><a href="#fiber的原理" class="header-anchor">#</a> <code>Fiber</code>的原理</h4> <h5 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h5> <p><code>scheduling</code>(调度)是<code>fiber reconciliation</code>的一个过程，主要决定应该在何时做什么。在<code>stack reconciler</code>中，<code>reconciliation</code>是“一气呵成”，对于函数来说，这没什么问题，因为我们只想要函数的运行结果，但对于UI来说还需要考虑以下问题：</p> <ul><li>并不是所有的<code>state</code>更新都需要立即显示出来，比如屏幕之外的部分的更新</li> <li>并不是所有的更新优先级都是一样的，比如用户输入的响应优先级要比通过请求填充内容的响应优先级更高</li> <li>理想情况下，对于某些高优先级的操作，应该是可以打断低优先级的操作执行的，比如用户输入时，页面的某个评论还在<code>reconciliation</code>，应该优先响应用户输入</li></ul> <p>所以理想状况下<code>reconciliation</code>的过程应该是像下图所示一样，每次只做一个很小的任务，做完后能够“喘口气儿”，回到主线程看下有没有什么更高优先级的任务需要处理，如果有则先处理更高优先级的任务，没有则继续执行(<code>cooperative scheduling</code> 合作式调度)。</p> <p><img src="/scheduler.jpg" alt="Scheduler"></p> <h5 id="任务拆分"><a href="#任务拆分" class="header-anchor">#</a> 任务拆分</h5> <p><strong><code>Stack reconciler</code></strong>：代码中创建（或更新）一些元素，<code>react</code>会根据这些元素创建（或更新）<code>Virtual DOM</code>，然后<code>react</code>根据更新前后<code>virtual DOM</code>的区别，去修改真正的<code>DOM</code>。注意，在<code>stack reconciler</code>下，<code>DOM</code>的更新是同步的，也就是说，在<code>virtual DOM</code>的比对过程中，发现一个<code>instance</code>有更新，会立即执行<code>DOM</code>操作。</p> <p><strong><code>Fiber reconciler</code></strong>：操作是可以分成很多小部分，并且可以被中断的，所以同步操作<code>DOM</code>可能会导致<code>fiber-tree</code>与实际<code>DOM</code>的不同步。对于每个节点来说，其不光存储了对应元素的基本信息，还要保存一些用于任务调度的信息。因此，<code>fiber</code>仅仅是一个对象，表征<code>reconciliation</code>阶段所能拆分的最小工作单元，和上图中的<code>react instance</code>一一对应。通过<code>stateNode</code>属性管理<code>Instance</code>自身的特性。通过<code>child</code>和<code>sibling</code>表征当前工作单元的下一个工作单元，<code>return</code>表示处理完成后返回结果所要合并的目标，通常指向父节点。<strong>整个结构是一个链表树</strong>。每个工作单元（<code>fiber</code>）执行完成后，都会查看是否还继续拥有主线程时间片，如果有继续下一个，如果没有则先处理其他高优先级事务，等主线程空闲下来继续执行。</p> <h2 id="redux"><a href="#redux" class="header-anchor">#</a> <code>Redux</code></h2> <p><code>Redux</code>的几个核心概念：</p> <ul><li><strong><code>Store</code></strong>：保存数据的地方，你可以把它看成一个容器，整个应用只能有一个<code>Store</code>。</li> <li><strong><code>State</code></strong>：<code>Store</code>对象包含所有数据，如果想得到某个时点的数据，就要对<code>Store</code>生成快照，这种时点的数据集合，就叫做<code>State</code>。</li> <li><strong><code>Action</code></strong>：<code>State</code>的变化，会导致<code>View</code>的变化。但是，用户接触不到<code>State</code>，只能接触到<code>View</code>。所以，<code>State</code>的变化必须是<code>View</code>导致的。<code>Action</code>就是<code>View</code>发出的通知，表示<code>State</code>应该要发生变化了。</li> <li><strong><code>Action Creator</code></strong>：<code>View</code>要发送多少种消息，就会有多少种<code>Action</code>。如果都手写，会很麻烦，所以我们定义一个函数来生成<code>Action</code>，这个函数就叫<code>Action Creator</code>。</li> <li><strong><code>Reducer</code></strong>：<code>Store</code>收到<code>Action</code>以后，必须给出一个新的<code>State</code>，这样<code>View</code>才会发生变化。这种<code>State</code>的计算过程就叫做Reducer。Reducer是一个函数，它接受<code>Action</code>和当前<code>State</code>作为参数，返回一个新的<code>State</code>。</li> <li><strong><code>dispatch</code></strong>：是<code>View</code>发出<code>Action</code>的唯一方法。</li></ul> <h3 id="redux的工作流程"><a href="#redux的工作流程" class="header-anchor">#</a> <code>Redux</code>的工作流程</h3> <p><img src="/redux-flow.png" alt="redux-flow"></p> <ol><li>用户（通过<code>View</code>）发出<code>Action</code>，发出方式就用到了<code>dispatch</code>方法。</li> <li><code>Store</code>自动调用<code>Reducer</code>，并且传入两个参数：当前<code>State</code>和收到的<code>Action</code>，<code>Reducer</code>会返回新的<code>State</code></li> <li><code>State</code>一旦有变化，<code>Store</code>就会调用监听函数，来更新<code>View</code>。</li></ol> <h3 id="react-redux"><a href="#react-redux" class="header-anchor">#</a> <code>React-Redux</code></h3> <h4 id="入口文件"><a href="#入口文件" class="header-anchor">#</a> 入口文件</h4> <ul><li><code>Provider</code>的作用是从最外部封装了整个应用，并向<code>connect</code>模块传递<code>store</code></li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 文件路径：@/index.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> browserHistory<span class="token punctuation">,</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> syncHistoryWithStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'@/store'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'@/routes'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token function">syncHistoryWithStore</span><span class="token punctuation">(</span>browserHistory<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Router</span></span> <span class="token attr-name">history</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span></span> <span class="token attr-name">routes</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>routes<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="store文件"><a href="#store文件" class="header-anchor">#</a> <code>store</code>文件</h4> <ul><li>通过<code>createStore</code>创建store</li> <li>通过<code>applyMiddleware</code>接入<code>redux-thunk</code>中间件</li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 文件路径：@/store</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">'redux-thunk'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rootReducer <span class="token keyword">from</span> <span class="token string">'@/reducers'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="reducer文件"><a href="#reducer文件" class="header-anchor">#</a> <code>reducer</code>文件</h4> <ul><li>通过<code>combineReducers</code>将各个子模块的reducer合并</li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 文件路径：@/reducers</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> routerReducer <span class="token keyword">as</span> routing <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> combineReducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> home <span class="token keyword">from</span> <span class="token string">'./home'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> user <span class="token keyword">from</span> <span class="token string">'./user'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> base <span class="token keyword">from</span> <span class="token string">'./base'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routing<span class="token punctuation">,</span>
  home<span class="token punctuation">,</span>
  user<span class="token punctuation">,</span>
  base<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="action文件"><a href="#action文件" class="header-anchor">#</a> <code>action</code>文件</h4> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 文件路径：@/actions/user</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'GET_USER_INFO'</span><span class="token punctuation">,</span> <span class="token operator">...</span>user <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="组件"><a href="#组件" class="header-anchor">#</a> 组件</h4> <ul><li>通过<code>connect</code>连接<code>React</code>组件和<code>Redux</code>，实现以下功能：
<ul><li>获取<code>state</code>: <code>connect</code>通过<code>context</code>获取<code>Provider</code>中的<code>store</code>，通过<code>store.getState()</code>获取整个<code>store tree</code>上所有<code>state</code></li> <li>包装原组件: 将<code>state</code>和<code>action</code>通过<code>props</code>的方式传入到原组件内部<code>wrapWithConnect</code>返回一个<code>ReactComponent</code>对象<code>Connect</code>，<code>Connect</code>重新<code>render</code>外部传入的原组件<code>WrappedComponent</code>，并把<code>connect</code>中传入的<code>mapStateToProps</code>, <code>mapDispatchToProps</code>与组件上原有的<code>props</code>合并后，通过属性的方式传给<code>WrappedComponent</code></li> <li>监听<code>store tree</code>变化: <code>connect</code>缓存了<code>store tree</code>中<code>state</code>的状态,通过当前<code>state</code>状态和变更前<code>state</code>状态进行比较,从而确定是否调用<code>this.setState()</code>方法触发<code>Connect</code>及其子组件的重新渲染</li></ul></li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getUserInfo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/actions/user'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span> userId<span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span> token<span class="token operator">:</span><span class="token string">'123'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">组件</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">mapStateToProps</span> <span class="token operator">=</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  user<span class="token operator">:</span> state<span class="token punctuation">.</span>user<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mapDispatchToProps <span class="token operator">=</span> <span class="token punctuation">{</span>
  getUserInfo<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapDispatchToProps<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="react-redux中如何进行异步操作"><a href="#react-redux中如何进行异步操作" class="header-anchor">#</a> <code>React-Redux</code>中如何进行异步操作</h3> <ul><li>直接在<code>componentDidmount</code>进行请求，无需借助<code>redux</code></li> <li>借助<code>redux</code>中间件</li></ul> <h3 id="redux中间件比较"><a href="#redux中间件比较" class="header-anchor">#</a> <code>Redux</code>中间件比较</h3> <h4 id="redux-thunk"><a href="#redux-thunk" class="header-anchor">#</a> <code>redux-thunk</code></h4> <p><strong>优点：</strong></p> <ul><li>体积小: redux-thunk的实现方式很简单,只有不到20行代码</li> <li>使用简单: redux-thunk没有引入像redux-saga或者redux-observable额外的范式,上手简单</li></ul> <p><strong>缺陷：</strong></p> <ul><li>样板代码过多: 与redux本身一样,通常一个请求需要大量的代码,而且很多都是重复性质的</li> <li>耦合严重: 异步操作与redux的action偶合在一起,不方便管理</li> <li>功能孱弱: 有一些实际开发中常用的功能需要自己进行封装</li></ul> <h4 id="redux-saga"><a href="#redux-saga" class="header-anchor">#</a> <code>redux-saga</code></h4> <p><strong>优点：</strong></p> <ul><li>异步解耦: 异步操作被被转移到单独<code>saga.js</code>中，不再是掺杂在<code>action.js</code>或<code>component.js</code>中</li> <li><code>action</code>摆脱<code>thunk function: dispatch</code>的参数，依然是一个纯粹的<code>action (FSA)</code>，而不是充满 “黑魔法”<code>thunk function</code></li> <li>异常处理: 受益于 <code>generator function</code> 的 <code>saga</code>实现，代码异常/请求失败 都可以直接通过 try/catch 语法直接捕获处理</li> <li>功能强大: <code>redux-saga</code>提供了大量的<code>Saga</code>辅助函数和<code>Effect</code>创建器供开发者使用，开发者无须封装或者简单封装即可使用</li> <li>灵活: <code>redux-saga</code>可以将多个<code>Saga</code>可以串行/并行组合起来，形成一个非常实用的异步<code>flow</code></li> <li>易测试: 提供了各种<code>case</code>的测试方案，包括<code>mock task</code>，分支覆盖等等</li></ul> <p><strong>缺陷：</strong></p> <ul><li>额外的学习成本: <code>redux-saga</code>不仅在使用难以理解的<code>generator function</code>，而且有数十个<code>API</code>,学习成本远超<code>redux-thunk</code>，最重要的是你的额外学习成本是只服务于这个库的，与<code>redux-observable</code>不同，<code>redux-observable</code>虽然也有额外学习成本但是背后是和<code>rxjs</code>一整套思想</li> <li>体积庞大: 体积略大,代码近2000行，min版25KB左右</li> <li>功能过剩: 实际上并发控制等功能很难用到,但是我们依然需要引入这些代码</li> <li><code>ts</code>支持不友好: <code>yield</code>无法返回TS类型</li></ul> <h4 id="redux-observable"><a href="#redux-observable" class="header-anchor">#</a> <code>redux-observable</code></h4> <p><strong>优点：</strong></p> <ul><li>功能最强: 由于背靠<code>rxjs</code>这个强大的响应式编程的库,借助<code>rxjs</code>的操作符,你可以几乎做任何你能想到的异步处理</li> <li>背靠<code>rxjs</code>: 由于有<code>rxjs</code>的加持,如果你已经学习了<code>rxjs</code>，<code>redux-observable</code>的学习成本并不高,而且随着<code>rxjs</code>的升级redux-observable也会变得更强大</li></ul> <p><strong>缺陷：</strong></p> <ul><li>学习成本奇高: 如果你不会<code>rxjs</code>，则需要额外学习两个复杂的库</li> <li>社区一般: <code>redux-observable</code>的下载量只有<code>redux-saga</code>的1/5，社区也不够活跃，在复杂异步流中间件这个层面<code>redux-saga</code>仍处于领导地位</li></ul> <h2 id="react-router"><a href="#react-router" class="header-anchor">#</a> <code>React-Router</code></h2> <p>前端路由是现代SPA应用必备的功能，每个现代前端框架都有对应的实现，例如<code>vue-router</code>、<code>react-router</code>。我们在这里不去探究<code>vue-router</code>或者<code>react-router</code>的实现，因为不管是哪种路由无外乎用兼容性更好的<code>hash</code>实现或者是<code>H5 History</code>实现，与框架匹配只需要做相应的封装即可。</p> <h3 id="hash路由"><a href="#hash路由" class="header-anchor">#</a> <code>Hash</code>路由</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Routers</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 储存hash与callback键值对</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前hash</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentUrl <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token comment">// 记录出现过的hash</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 作为指针,默认指向this.history的末尾,根据后退前进指向history中不同的hash</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>refresh <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>backOff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">backOff</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认不是后退操作</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isBack <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refresh<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refresh<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">route</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> callback <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentUrl <span class="token operator">=</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不是后退操作,且当前指针小于数组总长度,直接截取指针之前的部分储存下来</span>
      <span class="token comment">// 此操作来避免当点击后退按钮之后,再进行正常跳转,指针会停留在原地,而数组添加新hash路由</span>
      <span class="token comment">// 避免再次造成指针的不匹配,我们直接截取指针之前的数组</span>
      <span class="token comment">// 此操作同时与浏览器自带后退功能的行为保持一致</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentUrl<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'指针:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">,</span> <span class="token string">'history:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isBack <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 后退功能</span>
  <span class="token function">backOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 后退操作设置为true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isBack <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">&lt;=</span> <span class="token number">0</span>
      <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="history路由"><a href="#history路由" class="header-anchor">#</a> <code>History</code>路由</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Routers</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 在初始化时监听popstate事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bindPopState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化路由</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token operator">:</span> path<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将路径和对应回调函数加入hashMap储存</span>
  <span class="token function">route</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> callback <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发路由对应回调</span>
  <span class="token function">go</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token operator">:</span> path<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 监听popstate事件</span>
  <span class="token function">_bindPopState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> e<span class="token punctuation">.</span>state <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>state<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="路由切换动画"><a href="#路由切换动画" class="header-anchor">#</a> 路由切换动画</h3> <p>我们可以借助<code>React</code>的官方动画库<code>react-transition-group</code>来实现路由切换动画。</p> <p>示例如下：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token keyword">as</span> Router<span class="token punctuation">,</span> Route<span class="token punctuation">,</span> Link<span class="token punctuation">,</span> NavLink <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CSSTransition <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-transition-group'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Container<span class="token punctuation">,</span> Navbar<span class="token punctuation">,</span> Nav <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-bootstrap'</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'./pages/home'</span>
<span class="token keyword">import</span> About <span class="token keyword">from</span> <span class="token string">'./pages/about'</span>
<span class="token keyword">import</span> Contact <span class="token keyword">from</span> <span class="token string">'./pages/contact'</span>
<span class="token keyword">import</span> <span class="token string">'./styles.css'</span>

<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span> Component<span class="token operator">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/about'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span> Component<span class="token operator">:</span> About <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/contact'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span> Component<span class="token operator">:</span> Contact <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Router</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navbar</span></span> <span class="token attr-name">bg</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>light<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Nav</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mx-auto<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Nav.Link</span></span>
                <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span>
                <span class="token attr-name">as</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>NavLink<span class="token punctuation">}</span></span>
                <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span>
                <span class="token attr-name">activeClassName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>active<span class="token punctuation">&quot;</span></span>
                <span class="token attr-name">exact</span>
              <span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token punctuation">{</span>route<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Nav.Link</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Nav</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Navbar</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token punctuation">{</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> path<span class="token punctuation">,</span> Component <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span> <span class="token attr-name">exact</span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
              </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> match <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">CSSTransition</span></span>
                  <span class="token attr-name">in</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>match <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">}</span></span>
                  <span class="token attr-name">timeout</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">300</span><span class="token punctuation">}</span></span>
                  <span class="token attr-name">classNames</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>page<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">unmountOnExit</span>
                <span class="token punctuation">&gt;</span></span><span class="token plain-text">
                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>page<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">CSSTransition</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Router</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rootElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Example</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span> rootElement<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后修改时间:</span> <span class="time">8/28/2020, 3:06:34 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.be40bd60.js" defer></script><script src="/assets/js/2.fcfb7384.js" defer></script><script src="/assets/js/11.416a0fa6.js" defer></script>
  </body>
</html>
